# plat-cms Taskfile
#
# Generated by: xplat manifest bootstrap
# Customized for SpurtCMS integration
#
# Run 'task' to see available commands

version: "3"

vars:
  BINARY: plat-cms
  SRC_DIR: .src
  SPURTCMS_REPO: github.com/spurtcms/spurtcms

tasks:
  default:
    desc: Show available tasks
    cmds:
      - task --list

  # Top-level convenience aliases
  setup:
    desc: Initial setup - fetch SpurtCMS and initialize
    cmds:
      - task: src:fetch
      - task: go:mod
      - task: db:up
      - echo "Setup complete! Run 'xplat process' or 'task go:run' to start"

  up:
    desc: Start all services (database + CMS)
    cmds:
      - xplat process

  down:
    desc: Stop all services
    cmds:
      - docker compose down

  # Source tasks
  src:fetch:
    desc: Fetch SpurtCMS source into .src folder
    cmds:
      - mkdir -p {{.SRC_DIR}}
      - |
        if [ ! -d "{{.SRC_DIR}}/spurtcms" ]; then
          git clone --depth 1 https://{{.SPURTCMS_REPO}}.git {{.SRC_DIR}}/spurtcms
        else
          echo "SpurtCMS already fetched in {{.SRC_DIR}}/spurtcms"
        fi

  src:clean:
    desc: Remove fetched source
    cmds:
      - rm -rf {{.SRC_DIR}}/spurtcms

  # Go tasks (all use GOWORK=off)
  go:run:
    desc: Run SpurtCMS
    dir: "{{.SRC_DIR}}/spurtcms"
    env:
      GOWORK: off
    cmds:
      - go run main.go

  go:dev:
    desc: Run with hot reload (requires air)
    dir: "{{.SRC_DIR}}/spurtcms"
    env:
      GOWORK: off
    cmds:
      - |
        if command -v air &> /dev/null; then
          air
        else
          echo "air not installed, running without hot reload"
          go run main.go
        fi

  go:build:
    desc: Build the SpurtCMS binary
    dir: "{{.SRC_DIR}}/spurtcms"
    env:
      GOWORK: off
    cmds:
      - go build -o ../../{{.BINARY}} .

  go:test:
    desc: Run tests
    dir: "{{.SRC_DIR}}/spurtcms"
    env:
      GOWORK: off
    cmds:
      - go test ./...

  go:lint:
    desc: Run linter
    dir: "{{.SRC_DIR}}/spurtcms"
    env:
      GOWORK: off
    cmds:
      - golangci-lint run || echo "golangci-lint not installed, skipping"

  go:mod:
    desc: Tidy go modules
    dir: "{{.SRC_DIR}}/spurtcms"
    env:
      GOWORK: off
    cmds:
      - go mod tidy

  go:install:
    desc: Install to GOBIN
    dir: "{{.SRC_DIR}}/spurtcms"
    env:
      GOWORK: off
    cmds:
      - go install .

  go:clean:
    desc: Clean build artifacts
    cmds:
      - rm -f {{.BINARY}}

  # Database tasks
  db:up:
    desc: Start PostgreSQL database
    cmds:
      - docker compose up -d postgres

  db:down:
    desc: Stop PostgreSQL database
    cmds:
      - docker compose down

  db:reset:
    desc: Reset database (destroys all data)
    cmds:
      - docker compose down -v
      - docker compose up -d postgres

  db:seed:
    desc: Seed local blocks into database
    cmds:
      - docker exec -i plat-cms-postgres psql -U postgres -d spurtcms < seeds/blocks.sql
      - echo "Local blocks seeded successfully"

  db:seed-remote:
    desc: Seed remote SpurtCMS blocks into database
    cmds:
      - docker exec -i plat-cms-postgres psql -U postgres -d spurtcms < seeds/remote-blocks.sql
      - echo "Remote blocks seeded successfully"

  # Blocks tasks
  blocks:fetch:
    desc: Fetch blocks from SpurtCMS registry
    cmds:
      - ./scripts/fetch-blocks.sh

  blocks:local:
    desc: Use only local blocks (disable remote fetch)
    cmds:
      - |
        sed -i.bak 's|MASTER_BLOCKS_ENDPOINTURL.*|MASTER_BLOCKS_ENDPOINTURL=""|' {{.SRC_DIR}}/spurtcms/.env
        echo "Remote blocks disabled. Using local blocks only."

  blocks:remote:
    desc: Re-enable remote blocks from SpurtCMS
    cmds:
      - |
        sed -i.bak 's|MASTER_BLOCKS_ENDPOINTURL.*|MASTER_BLOCKS_ENDPOINTURL="https://superadmin.spurtcms.com/defaultblocklist/"|' {{.SRC_DIR}}/spurtcms/.env
        echo "Remote blocks re-enabled."
