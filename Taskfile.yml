# plat-cms Taskfile
#
# Generated by: xplat manifest bootstrap
# Customized for SpurtCMS integration
#
# Run 'task' to see available commands

version: "3"

vars:
  BINARY: plat-cms
  MAIN: .
  SRC_DIR: .src
  SPURTCMS_REPO: github.com/spurtcms/spurtcms

tasks:
  default:
    desc: Show available tasks
    cmds:
      - task --list

  setup:
    desc: Initial setup - fetch SpurtCMS and initialize
    cmds:
      - task: fetch
      - task: mod
      - task: db:up
      - echo "Setup complete! Run 'xplat process' or 'task run' to start"

  fetch:
    desc: Fetch SpurtCMS source into .src folder
    cmds:
      - mkdir -p {{.SRC_DIR}}
      - |
        if [ ! -d "{{.SRC_DIR}}/spurtcms" ]; then
          git clone --depth 1 https://{{.SPURTCMS_REPO}}.git {{.SRC_DIR}}/spurtcms
        else
          echo "SpurtCMS already fetched in {{.SRC_DIR}}/spurtcms"
        fi

  build:
    desc: Build the SpurtCMS binary
    dir: "{{.SRC_DIR}}/spurtcms"
    cmds:
      - go build -o ../../{{.BINARY}} .

  test:
    desc: Run tests
    cmds:
      - go test ./...

  lint:
    desc: Run linter
    cmds:
      - golangci-lint run || echo "golangci-lint not installed, skipping"

  clean:
    desc: Clean build artifacts
    cmds:
      - rm -f {{.BINARY}}

  install:
    desc: Install to GOBIN
    cmds:
      - go install {{.MAIN}}

  run:
    desc: Run SpurtCMS from .src folder
    dir: "{{.SRC_DIR}}/spurtcms"
    cmds:
      - go run main.go

  dev:
    desc: Run in development mode with hot reload
    cmds:
      - |
        if command -v air &> /dev/null; then
          air
        else
          echo "air not installed, running without hot reload"
          task run
        fi

  mod:
    desc: Tidy go modules
    cmds:
      - go mod tidy

  # Database tasks
  db:up:
    desc: Start PostgreSQL database
    cmds:
      - docker compose up -d postgres

  db:down:
    desc: Stop PostgreSQL database
    cmds:
      - docker compose down

  db:reset:
    desc: Reset database (destroys all data)
    cmds:
      - docker compose down -v
      - docker compose up -d postgres

  # All-in-one commands
  up:
    desc: Start all services (database + CMS)
    cmds:
      - xplat process

  down:
    desc: Stop all services
    cmds:
      - docker compose down
